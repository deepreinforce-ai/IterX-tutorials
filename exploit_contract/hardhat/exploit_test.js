const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("Exploit Test", function () {
  const ATTACKER_BUDGET = ethers.parseEther("1");

  let vault;
  let exploit;
  let attacker;
  let victim1;
  let victim2;

  beforeEach(async function () {
    [attacker, victim1, victim2] = await ethers.getSigners();

    // Deploy vault
    const VaultFactory = await ethers.getContractFactory("VulnerableVault");
    vault = await VaultFactory.connect(victim1).deploy();
    await vault.waitForDeployment();

    // Setup Main Pool (5 ETH from victim deposits)
    await vault.connect(victim1).deposit({ value: ethers.parseEther("3") });
    await vault.connect(victim2).deposit({ value: ethers.parseEther("2") });
    
    // Setup Bonus Pool (2 ETH)
    await vault.connect(victim1).fundBonusPool({ value: ethers.parseEther("2") });
    
    // Setup Treasury Pool (2 ETH)
    await vault.connect(victim1).fundTreasury({ value: ethers.parseEther("2") });

    // Deploy exploit contract
    const ExploitFactory = await ethers.getContractFactory("Exploit");
    exploit = await ExploitFactory.connect(attacker).deploy(await vault.getAddress());
    await exploit.waitForDeployment();
  });

  it("Exploit: Measure ETH extraction", async function () {
    const vaultBalanceBefore = await vault.getVaultBalance();
    
    // Execute attack
    try {
      await exploit.connect(attacker).attack({ value: ATTACKER_BUDGET, gasLimit: 10000000 });
    } catch (e) {
      console.log("Attack error:", e.message?.slice(0, 200));
    }

    // Mine blocks for governance
    await ethers.provider.send("evm_mine", []);
    await ethers.provider.send("evm_mine", []);

    // Collect loot
    try {
      await exploit.connect(attacker).collectLoot({ gasLimit: 10000000 });
    } catch (e) {
      console.log("CollectLoot error:", e.message?.slice(0, 200));
    }

    // Results
    const vaultBalanceAfter = await vault.getVaultBalance();
    const exploitBalance = await exploit.getBalance();
    const totalPossible = vaultBalanceBefore + ATTACKER_BUDGET;
    const extractedFromVault = totalPossible - vaultBalanceAfter;
    
    console.log("\n=== Exploit Results ===");
    console.log(`Vault before: ${ethers.formatEther(vaultBalanceBefore)} ETH`);
    console.log(`Attacker budget: ${ethers.formatEther(ATTACKER_BUDGET)} ETH`);
    console.log(`Vault after: ${ethers.formatEther(vaultBalanceAfter)} ETH`);
    console.log(`Exploit contract: ${ethers.formatEther(exploitBalance)} ETH`);
    console.log(`Extracted: ${ethers.formatEther(extractedFromVault)} ETH`);
    console.log("=======================\n");
  });
});
